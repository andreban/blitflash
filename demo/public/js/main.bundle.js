(()=>{"use strict";var e={349:(e,t,i)=>{t.E_=void 0;const n=i(732);Object.defineProperty(t,"E_",{enumerable:!0,get:function(){return n.BlitFlasher}});i(837)},426:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{a(n.next(e))}catch(e){o(e)}}function d(e){try{a(n.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.BlitConnection=void 0;const r=i(837),o=i(479);t.BlitConnection=class{constructor(e,t,i={debug:!1}){this.reader=e,this.writer=t,this.options=i,this.debug=!1,this.encoder=new TextEncoder,this.decoder=new TextDecoder,this.readBuffer=new o.ReadBuffer,this.readLoop()}readLoop(){return n(this,void 0,void 0,(function*(){for(;;){const{value:e,done:t}=yield this.reader.read();if(e&&(this.options.debug&&console.log(">>>",this.decoder.decode(e)),this.readBuffer.append(e)),t){this.reader.releaseLock(),this.readBuffer.failPendingPromises(new Error("ReadableStream is done."));break}}}))}write(e){return n(this,void 0,void 0,(function*(){const t=this.encoder.encode(e);yield this.writer.write(t)}))}close(){return n(this,void 0,void 0,(function*(){yield this.writer.close(),yield this.reader.cancel()}))}reset(){return n(this,void 0,void 0,(function*(){yield this.write("32BL_RST\0"),yield this.writer.ready}))}status(){return n(this,void 0,void 0,(function*(){yield this.write("32BLINFO\0");const e=yield this.readBuffer.read(8);return this.decoder.decode(e)}))}list(){return n(this,void 0,void 0,(function*(){const e=[];yield this.write("32BL__LS\0");let t=yield this.readBuffer.readUint32(!0);for(;4294967295!==t;){let i=yield this.readBuffer.readUint32(!0);const n=this.decoder.decode(yield this.readBuffer.read(8));if("BLITMETA"!==n)throw new Error(`Incorret meta header. Received ${n}`);const o=yield this.readBuffer.readUint16(!0);let s;o>0&&(i=i+o+10,s=r.BlitMetaStandalone.parse((yield this.readBuffer.read(o)).buffer)),e.push({offset:t,size:i,meta:s}),t=yield this.readBuffer.readUint32(!0)}return e}))}sendFile(e,t,i,r=""){return n(this,void 0,void 0,(function*(){const n=e.byteLength;let o;"sd"===t?(this.options.debug&&console.log(`Saving ${i} (${n} bytes) as in ${r}.`),o=`32BLSAVE${r}/${i}\0${n}\0`):(this.options.debug&&console.log(`Flashing ${i} (${n} bytes)`),o=`32BLPROG${i}\0${n}\0`),yield this.write(o);let s=0;const d=new Uint8Array(e);for(;s<n;){yield this.writer.ready;const e=Math.min(s+1024,n);this.writer.write(d.slice(s,e)),s=e}yield this.writer.ready,this.options.debug&&console.log(`Wrote ${e.byteLength} bytes`);const a=yield this.readBuffer.readString(8);if("32BL__OK"!==a)throw new Error(`Failed to send file with result ${a}.`)}))}}},732:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{a(n.next(e))}catch(e){o(e)}}function d(e){try{a(n.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.BlitFlasher=void 0;const r=i(426),o=i(437),s={usbVendorId:1155,usbProductId:22336},d=[s];t.BlitFlasher=class{constructor(e,t={debug:!1}){this.port=e,this.options=t,this.port=e}open(){return n(this,void 0,void 0,(function*(){yield this.port.open({baudRate:115200,dataBits:8,stopBits:1}),this.connection=new r.BlitConnection(this.port.readable.getReader(),this.port.writable.getWriter(),{debug:this.options.debug})}))}close(){var e,t;return n(this,void 0,void 0,(function*(){yield null===(e=this.connection)||void 0===e?void 0:e.close(),yield null===(t=this.port)||void 0===t?void 0:t.close()}))}status(){return n(this,void 0,void 0,(function*(){return this.connection.status()}))}list(){return n(this,void 0,void 0,(function*(){return this.connection.list()}))}sendFile(e,t,i,r=""){return n(this,void 0,void 0,(function*(){return this.connection.sendFile(e,t,i,r)}))}reset(){return n(this,void 0,void 0,(function*(){this.connection&&(yield this.connection.reset(),yield this.connection.close(),yield this.port.close()),yield o.sleep(1e3),yield this.open()}))}static supportsWebSerial(){return"serial"in navigator}static getOrRequestPort(){return n(this,void 0,void 0,(function*(){const e=yield this.getPorts();return e.length>0?e[0]:yield this.requestPort()}))}static getPorts(){return n(this,void 0,void 0,(function*(){return(yield navigator.serial.getPorts()).filter((e=>{const t=e.getInfo();return t.usbProductId==s.usbProductId&&t.usbVendorId===s.usbVendorId}))}))}static requestPort(){return n(this,void 0,void 0,(function*(){return yield navigator.serial.requestPort({filters:d})}))}}},837:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BlitMetaStandalone=t.BlitImage=void 0;const n=i(856);class r{constructor(e,t,i,n,r,o,s){this.type=e,this.dataLength=t,this.width=i,this.height=n,this.format=r,this.palette=o,this.pixels=s}asDataUrl(){const e=this.unpack();if(!e)return null;const t=document.createElement("canvas");t.width=this.width,t.height=this.height;const i=t.getContext("2d");if(!i)return console.error("Failed to create a 2d canvas context."),null;const n=i.createImageData(this.width,this.height);return n.data.set(e),i.putImageData(n,0,0),t.toDataURL()}unpack(){if(2!==this.format)return null;const e=new Uint8Array(this.palette),t=new Uint8Array(this.pixels),i=new Uint8Array(new ArrayBuffer(this.width*this.height*4));if("PK"===this.type){const n=Math.ceil(Math.log2(e.length/4));let r=0,o=0,s=0;for(const d of t)for(let t=0;t<8;t++)o<<=1,o|=d>>7-t&1,++s==n&&(i[r++]=e[4*o+0],i[r++]=e[4*o+1],i[r++]=e[4*o+2],i[r++]=e[4*o+3],s=0,o=0);return i}if("RL"===this.type){const n=Math.ceil(Math.log2(e.length/4));let r=0,o=0,s=0,d=0,a=0;for(const c of t)for(let t=0;t<8;t++)switch(a){case 0:a=c&128>>t?1:2;break;case 1:d<<=1,d|=c>>7-t&1,8==++s&&(a=2,s=0);break;case 2:if(o<<=1,o|=c>>7-t&1,++s==n){for(let t=0;t<=d;t++)i[r++]=e[4*o+0],i[r++]=e[4*o+1],i[r++]=e[4*o+2],i[r++]=e[4*o+3];s=0,o=0,d=0,a=0}}return i}return null}numPixels(){return this.width*this.height}static parse(e){const t=e.readString(6);if("SPRITE"!==t)throw new Error(`Invalid header for BlitImage: ${t}`);const i=e.readString(2),n=e.readUint32(!0),o=e.readUint16(!0),s=e.readUint16(!0),d=e.readUint8();let a=e.readUint8();0===a&&(a=256);const c=e.read(4*a),l=e.read(n-18-4*a);return new r(i,n,o,s,d,c,l)}}t.BlitImage=r;class o{constructor(e,t,i,n,r,o,s,d,a,c,l,u){this.checksum=e,this.date=t,this.title=i,this.description=n,this.version=r,this.author=o,this.blittype=s,this.category=d,this.url=a,this.filetypes=c,this.icon=l,this.splash=u}static parse(e){const t=new n.RandomAccessReader(e),i=t.readUint32(!0),s=t.readString(16),d=t.readString(25),a=t.readString(129),c=t.readString(17),l=t.readString(17);let u,h,f;const v=t.getPos(),y=t.readString(8);if("BLITTYPE"===y){u=t.readString(17),h=t.readString(129);const e=t.readUint8();f=[];for(let i=0;i<e;i++)f.push(t.readString(5))}else t.setPos(v);const g=r.parse(t),p=r.parse(t);return new o(i,s,d,a,c,l,y,u,h,f,g,p)}}t.BlitMetaStandalone=o},856:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.RandomAccessReader=void 0,t.RandomAccessReader=class{constructor(e){this.buffer=e,this.textdecoder=new TextDecoder,this.currentPos=0,this.dataview=new DataView(e)}read(e){if(this.currentPos+e>this.dataview.byteLength)throw new Error(`Tried to read beyond length. pos: ${this.currentPos}, buffer byteLength: ${this.dataview.byteLength}, length: ${e} `);const t=this.buffer.slice(this.currentPos,this.currentPos+e);return this.currentPos+=e,t}readUint8(){if(this.currentPos+1>=this.dataview.byteLength)throw new Error("Tried to read beyond length.");const e=this.dataview.getUint8(this.currentPos);return this.currentPos+=1,e}readUint16(e){if(this.currentPos+2>=this.dataview.byteLength)throw new Error("Tried to read beyond length.");const t=this.dataview.getUint16(this.currentPos,e);return this.currentPos+=2,t}readUint32(e){if(this.currentPos+4>=this.dataview.byteLength)throw new Error("Tried to read beyond length.");const t=this.dataview.getUint32(this.currentPos,e);return this.currentPos+=4,t}readString(e){const t=new Uint8Array(this.read(e));let i=t.findIndex((e=>0===e));return-1===i&&(i=e),this.textdecoder.decode(t.slice(0,i))}getPos(){return this.currentPos}setPos(e){if(e>=this.dataview.byteLength)throw new Error("Cant set position beyond length.");this.currentPos=e}byteLength(){return this.dataview.byteLength}}},479:function(e,t){var i=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{a(n.next(e))}catch(e){o(e)}}function d(e){try{a(n.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ReadBuffer=void 0;class n{constructor(e,t,i){this.dataLength=e,this.resolve=t,this.reject=i}}t.ReadBuffer=class{constructor(e=1024){this.pendingPromises=[],this._size=0,this.decoder=new TextDecoder,this.buffer=new Uint8Array(new ArrayBuffer(e))}read(e){return i(this,void 0,void 0,(function*(){return 0===this.pendingPromises.length&&this.size()>=e?yield this.internalRead(e):new Promise(((t,i)=>{this.pendingPromises.push(new n(e,t,i))}))}))}readUint8(){return i(this,void 0,void 0,(function*(){const e=yield this.read(1);return new DataView(e.buffer).getUint8(0)}))}readUint16(e){return i(this,void 0,void 0,(function*(){const t=yield this.read(2);return new DataView(t.buffer).getUint16(0,e)}))}readUint32(e){return i(this,void 0,void 0,(function*(){const t=yield this.read(4);return new DataView(t.buffer).getUint32(0,e)}))}readString(e){return i(this,void 0,void 0,(function*(){const t=yield this.read(e);let i=t.findIndex((e=>0===e));return-1===i&&(i=e-1),this.decoder.decode(t.slice(0,i+1))}))}append(e){this.size()+e.byteLength>this.buffer.byteLength&&this.extendBuffer(),this.buffer.set(e,this.size()),this._size+=e.byteLength,this.tryResolvePendingPromises()}failPendingPromises(e){for(;this.pendingPromises.length>0;)this.pendingPromises.shift().reject(e)}size(){return this._size}capacity(){return this.buffer.byteLength}internalRead(e){return i(this,void 0,void 0,(function*(){if(this.size()<e)throw new Error(`Internal buffer has ${this.size} bytes, but tried to read ${e}.`);this._size-=e;const t=new Uint8Array(this.buffer.subarray(0,e));return this.buffer.copyWithin(0,e,e+this.size()),t}))}tryResolvePendingPromises(){return i(this,void 0,void 0,(function*(){for(;this.pendingPromises.length>0&&this.pendingPromises[0].dataLength<=this.size();){const e=this.pendingPromises.shift(),t=yield this.internalRead(e.dataLength);e.resolve(t)}}))}extendBuffer(){const e=new Uint8Array(new ArrayBuffer(2*this.buffer.byteLength));e.set(this.buffer),this.buffer=e}}},437:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.sleep=void 0,t.sleep=function(e){return new Promise((t=>setTimeout(t,e)))}}},t={};function i(n){var r=t[n];if(void 0!==r)return r.exports;var o=t[n]={exports:{}};return e[n].call(o.exports,o,o.exports,i),o.exports}(()=>{var e=i(349),t=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{a(n.next(e))}catch(e){o(e)}}function d(e){try{a(n.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}))};const n=document.querySelector("#connect"),r=document.querySelector("#disconnect"),o=document.querySelector("#status"),s=document.querySelector("#reset"),d=document.querySelector("#list"),a=document.querySelector("#flash"),c=document.querySelector("#sd"),l=document.querySelector("#status_text"),u=document.querySelector("#list-content");e.E_.supportsWebSerial()&&(n.disabled=!1);let h=null;n.addEventListener("click",(()=>t(void 0,void 0,void 0,(function*(){const t=yield e.E_.getOrRequestPort();h=new e.E_(t),yield h.open(),n.disabled=!0,r.disabled=!1,o.disabled=!1,s.disabled=!1,d.disabled=!1,a.disabled=!1,c.disabled=!1;const i=yield h.status();l.innerText=i})))),r.addEventListener("click",(()=>t(void 0,void 0,void 0,(function*(){yield null==h?void 0:h.close(),h=null,n.disabled=!1,r.disabled=!0,o.disabled=!0,s.disabled=!0,d.disabled=!0,a.disabled=!0,c.disabled=!0})))),s.addEventListener("click",(()=>t(void 0,void 0,void 0,(function*(){if(null===h)return void console.error("Not Connected");yield h.reset();const e=yield h.status();l.innerText=e})))),o.addEventListener("click",(()=>t(void 0,void 0,void 0,(function*(){if(null===h)return void console.error("Not Connected");const e=yield h.status();l.innerText=e})))),d.addEventListener("click",(()=>t(void 0,void 0,void 0,(function*(){if(null===h)return void console.error("Not Connected");const e=yield h.list();u.innerHTML="",e.forEach((e=>{var t,i,n,r,o,s,d;const a=document.createElement("tr");let c=document.createElement("td");c.innerText=(null===(t=e.meta)||void 0===t?void 0:t.title)||"",a.appendChild(c),c=document.createElement("td");const l=null===(n=null===(i=e.meta)||void 0===i?void 0:i.splash)||void 0===n?void 0:n.asDataUrl();if(l){const e=document.createElement("img");e.src=l,c.appendChild(e)}else c.innerText="N/A";a.appendChild(c),c=document.createElement("td"),c.innerText=(null===(r=e.meta)||void 0===r?void 0:r.description)||"",a.appendChild(c),c=document.createElement("td"),c.innerText=(null===(o=e.meta)||void 0===o?void 0:o.author)||"",a.appendChild(c),c=document.createElement("td"),c.innerText=(null===(s=e.meta)||void 0===s?void 0:s.date)||"",a.appendChild(c),c=document.createElement("td"),c.innerText=(null===(d=e.meta)||void 0===d?void 0:d.version)||"",a.appendChild(c),u.appendChild(a)}))})))),a.addEventListener("click",(()=>t(void 0,void 0,void 0,(function*(){if(null===h)return void console.error("Not Connected");const e=yield fetch("snake.blit"),t=new Uint8Array(yield e.arrayBuffer());console.log(`Received arrayBuffer with size ${t.byteLength}`);try{yield h.sendFile(t,"flash","snake.blit"),alert("snake.blit flashed successfully")}catch(e){console.error("Error uploading blit file",e)}})))),c.addEventListener("click",(()=>t(void 0,void 0,void 0,(function*(){if(null===h)return void console.error("Not Connected");const e=yield fetch("snake.blit"),t=new Uint8Array(yield e.arrayBuffer());console.log(`Received arrayBuffer with size ${t.byteLength}`);try{yield h.sendFile(t,"sd","snake.blit","/"),alert("snake.blit flashed successfully")}catch(e){console.error("Error uploading blit file",e)}}))))})()})();